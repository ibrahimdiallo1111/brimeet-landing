<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques Cr√©ateur ‚Äì BriMeet</title>

    <!-- üéØ Favicon et ic√¥nes multi-plateformes -->
    <!-- Ic√¥ne PNG pour navigateurs classiques -->
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <!-- Ic√¥ne SVG pour navigateurs modernes -->
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <!-- Favicon ICO pour compatibilit√© maximale -->
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <!-- Ic√¥ne Apple pour √©cran d‚Äôaccueil iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <!-- Nom affich√© lors de l‚Äôajout √† l‚Äô√©cran d‚Äôaccueil iOS -->
    <meta name="apple-mobile-web-app-title" content="BriMeet" />
    <!-- Manifest PWA pour Chrome/Android -->
    <link rel="manifest" href="/favicon/site.webmanifest" />

    <!-- Google Analytics -->
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QH2N81X6GM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-QH2N81X6GM');
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f4f8fb;
            color: #333;
        }

        header {
            background: #0077cc;
            color: white;
            text-align: center;
            padding: 20px;
        }

        main {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #0077cc;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th,
        table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        table th {
            background: #0077cc;
            color: white;
        }

        .transfer-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 20px;
            background: #0077cc;
            color: white;
            border-radius: 6px;
            text-decoration: none;
        }

        .transfer-btn:hover {
            background: #005fa3;
        }

        .note {
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
        }

        /* ‚úÖ Footer stylis√© */
        footer {
            background-color: #0077cc;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
        }

        footer a {
            color: #ffdd57;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {

            table th,
            table td {
                padding: 6px;
                font-size: 0.8em;
            }
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            /* d√©filement fluide sur iOS */
        }
    </style>

</head>

<body>
    <header>
        <h1>üìä Statistiques Cr√©ateur BriMeet</h1>
        <p>Suivez vos performances et vos revenus</p>
    </header>

    <main>
        <h2>Vos performances</h2>
        <div class="table-container">
            <table>
                <tr>
                    <th>Abonn√©s</th>
                    <th>Likes cumul√©s</th>
                    <th>Invitations</th>
                    <th>Pourcentage revenu</th>
                    <th>Statut</th>
                </tr>
                <tr>
                    <td id="audience">--</td>
                    <td id="likes">--</td>
                    <td id="invites">--</td>
                    <td id="percent">--</td>
                    <td id="status">--</td>
                </tr>
            </table>

        </div>

        <h2>Vos revenus</h2>
        <div class="table-container">
            <table>
                <tr>
                    <th>Revenu en cours</th>
                    <th>Revenu mois pass√©</th>
                    <th>Solde total valid√©</th>
                </tr>
                <tr>
                    <td id="current_revenue">‚è≥ En cours</td>
                    <td id="last_revenue">--</td>
                    <td id="total_balance">--</td>
                </tr>
            </table>
        </div>

        <a href="#" class="transfer-btn" id="transferBtn">üí≥ Transf√©rer vers mon solde BriMeet</a>

        <div id="confirmModal" style="display:none; 
     position:fixed; top:0; left:0; width:100%; height:100%; 
     background:rgba(0,0,0,0.5); text-align:center; padding-top:200px;">
            <div style="background:white; padding:20px; border-radius:8px; max-width:400px; margin:auto;">
                <p>‚ö†Ô∏è Confirmation : Le transfert inclut le solde total valid√© (revenu du mois pass√© + cumules).<br>
                    Le revenu en cours sera ajout√© apr√®s validation (mise √† jour le 5 de chaque mois).</p>
                <button onclick="proceedTransfer()">‚úÖ Continuer</button>
                <button onclick="closeModal()">‚ùå Annuler</button>
            </div>
        </div>

        <div id="successModal" style="display:none; 
     position:fixed; top:0; left:0; width:100%; height:100%; 
     background:rgba(0,0,0,0.5); text-align:center; padding-top:200px;">
            <div style="background:white; padding:20px; border-radius:8px; max-width:400px; margin:auto;">
                <h3 style="color:green;">‚úÖ Transfert r√©ussi</h3>
                <p id="successMessage"></p>
                <button onclick="goToWallet()">üíº Voir mon solde BriMeet</button>
            </div>
        </div>

        <script>
            const modal = document.getElementById("confirmModal");
            const successModal = document.getElementById("successModal");

            document.getElementById("transferBtn").addEventListener("click", function (e) {
                e.preventDefault();
                modal.style.display = "block";
            });

            function closeModal() {
                modal.style.display = "none";
            }

            function showSuccess(amount, balance) {
                document.getElementById("successMessage").textContent =
                    `${amount} $ envoy√©s vers ton solde BriMeet.`;
                successModal.style.display = "block";
            }

            function goToWallet() {
                window.location.href = "/wallet.html"; // redirection apr√®s succ√®s
            }

            async function proceedTransfer() {
                try {
                    const response = await fetch(`${backendUrl}/creator-partnership/transfer`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        closeModal(); // ‚úÖ fermer la modale de confirmation
                        localStorage.setItem("walletBalance", result.balance); // ‚úÖ stocker le solde
                        showSuccess(result.amount, result.balance); // ‚úÖ afficher la modale de succ√®s
                    } else {
                        alert("‚ùå Erreur : " + result.error);
                    }
                } catch (err) {
                    console.error("Erreur transfert :", err);
                    alert("‚ùå Impossible de r√©aliser le transfert.");
                }
            }
        </script>



        <p class="note">‚ÑπÔ∏è Le revenu en cours est mis √† jour le 5 de chaque mois et devient ‚ÄúRevenu mois pass√©‚Äù.</p>

        <p class="note">
            üìà Ton pourcentage de revenu √©volue automatiquement en fonction de ton audience et de tes likes.
            Chaque nouveau palier atteint est pris en compte lors des mises √† jour r√©guli√®res du programme.
        </p>

        <p id="suspendedNote" class="note"
            style="display:none; background:#ffe5e5; color:red; font-weight:bold; padding:10px; border-radius:6px;">
            ‚è∏Ô∏è Ton programme est actuellement suspendu.<br>
            Pour le r√©activer, tu dois atteindre le palier suivant (nouveau seuil d‚Äôabonn√©s et de likes).
        </p>

        <p style="background:#f5f5f5; padding:10px; border-radius:6px; color:#333; font-size:0.9em; margin-top:20px;">
            üìÖ Programme actif du <span id="program_start">--</span> au <span id="program_end">--</span>
        </p>





        <!-- Bouton R√©essayer cach√© par d√©faut -->
        <div id="retryContainer" style="display:none; text-align:center; margin-top:20px;">
            <p>‚ùå Impossible de charger les statistiques.</p>
            <button id="retryBtn">üîÑ R√©essayer</button>
        </div>


    </main>

    <footer>
        <p>&copy; 2025 BriMeet. Tous droits r√©serv√©s.</p>
        <p>üì© Contact : <a href="mailto:contact@brimeet.com" style="color:white;">contact@brimeet.com</a></p>
    </footer>

    <script>
        const backendUrl = "https://api.brimeet.com";
        const token = localStorage.getItem("authToken");

        async function loadStats() {
            try {
                const response = await fetch(`${backendUrl}/creator-partnership/stats`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({}) // tu peux envoyer vide ou avec userId si besoin
                });

                const text = await response.text();
                console.log("raw response:", text);

                const data = JSON.parse(text); // si ce n'est pas du JSON ‚Üí erreur

                // ‚úÖ Remplir le tableau
                document.getElementById("audience").textContent = data.audience || "--";
                document.getElementById("likes").textContent = data.likes || "--";
                document.getElementById("invites").textContent = data.invites || "--";
                document.getElementById("percent").textContent = data.percent ? data.percent + "%" : "--";
                document.getElementById("status").textContent = data.status === "suspended" ? "‚è∏Ô∏è Suspendu" : data.status || "--";
                document.getElementById("current_revenue").textContent = data.status === "suspended" ? "‚è∏Ô∏è Suspendu" : (data.current_revenue ? data.current_revenue + " $" : "‚è≥ En cours");
                document.getElementById("last_revenue").textContent = data.last_revenue ? data.last_revenue + " $" : "--";
                document.getElementById("total_balance").textContent = data.total_balance ? data.total_balance + " $" : "--";
                document.getElementById("program_start").textContent = data.program_start ? new Date(data.program_start).toLocaleDateString() : "--";
                document.getElementById("program_end").textContent = data.program_end ? new Date(data.program_end).toLocaleDateString() : "--";


                // ‚úÖ Afficher la note si revenu en MAD > 0 mais last_revenue = 0
                if (data.mad_revenue > 0 && (!data.last_revenue || data.last_revenue === 0)) {
                    const note = document.createElement("p");
                    note.className = "note";
                    note.style.color = "orange";
                    note.textContent = "‚ÑπÔ∏è Il se peut que tu commences √† g√©n√©rer du revenu, mais il ne peut pas √™tre affich√© tant qu'il n'atteint pas 1 $.";
                    document.querySelector("main").appendChild(note);
                }


                // ‚úÖ Afficher la note si suspendu
                if (data.status === "suspended") {
                    document.getElementById("suspendedNote").style.display = "block";
                } else {
                    document.getElementById("suspendedNote").style.display = "none";
                }


                // ‚úÖ Afficher la note si expir√© et pas encore demand√©
                if (data.program_status === "expired" && data.renewal_request === "none") {
                    const renewalBtn = document.createElement("button");
                    renewalBtn.textContent = "üîÑ Demander un renouvellement";
                    renewalBtn.onclick = async () => {
                        try {
                            const response = await fetch(`${backendUrl}/creator-partnership/renewal`, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${token}`
                                },
                                body: JSON.stringify({ userId: data.user_id })
                            });

                            const result = await response.json();

                            if (result.success) {
                                renewalBtn.style.display = "none";
                                const note = document.createElement("p");
                                note.textContent = "üì© Votre demande de renouvellement est en cours. Vous serez notifi√© par email.";
                                document.querySelector("main").appendChild(note);
                                document.getElementById("status").textContent = "‚è≥ Expir√©";
                                document.getElementById("current_revenue").textContent = "‚è≥ Expir√©";
                            } else {
                                alert("‚ùå Erreur : " + (result.error || "Impossible d'enregistrer la demande."));
                            }
                        } catch (err) {
                            console.error("‚ùå Erreur lors de la demande de renouvellement:", err);
                            alert("‚ùå Impossible de soumettre la demande de renouvellement. V√©rifiez votre connexion.");
                        }
                    };
                    document.getElementById("status").textContent = "‚è≥ Expir√©";
                    document.getElementById("current_revenue").textContent = "‚è≥ Expir√©";
                    document.querySelector("main").appendChild(renewalBtn);
                }

                // ‚úÖ Afficher un message si demande de renouvellement d√©j√† en cours
                if (data.program_status === "expired" && data.renewal_request === "pending") {
                    const note = document.createElement("p");
                    note.className = "note";
                    note.style.color = "blue";
                    note.textContent = "üì© Votre demande de renouvellement est en cours. Vous serez notifi√© par email.";
                    document.querySelector("main").appendChild(note);

                    document.getElementById("status").textContent = "‚è≥ Expir√©";
                    document.getElementById("current_revenue").textContent = "‚è≥ Expir√©";
                }



                // ‚úÖ Afficher un message si programme termin√© d√©finitivement
                if (data.program_status === "terminated") {
                    const note = document.createElement("p");
                    note.className = "note";
                    note.style.color = "red";
                    note.textContent = "‚õî Votre programme est termin√© d√©finitivement. Vous ne pouvez plus demander de renouvellement.";
                    document.querySelector("main").appendChild(note);

                    // Mettre le status √† "Termin√©"
                    document.getElementById("status").textContent = "‚õî Termin√©";
                    // Mettre revenu en cours √† "Termin√©"
                    document.getElementById("current_revenue").textContent = "‚õî Termin√©";
                }




                // ‚úÖ Masquer le bouton R√©essayer si √ßa marche
                document.getElementById("retryContainer").style.display = "none";

            } catch (err) {
                console.error("‚ùå Erreur lors du chargement des stats:", err);
                // ‚úÖ Afficher le bouton R√©essayer
                document.getElementById("retryContainer").style.display = "block";
            }
        }

        // Charger au d√©marrage
        document.addEventListener("DOMContentLoaded", loadStats);

        // Bouton R√©essayer
        document.getElementById("retryBtn").addEventListener("click", loadStats);
    </script>

</body>

</html>